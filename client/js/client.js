var XML_TELTYPES = null;var XSL_PERSONS = null;var XSL_PERSON_FORM = null;var XSL_MESSAGES = null;var XSL_TELEPHONES = null;function reload_persons() {	$.get('persons').done(function(xml) {		$('#persons').html(xsl_transform(xml, XSL_PERSONS));		$('#persons-messages').html(xsl_transform(xml, XSL_MESSAGES));	});}function reload_telephones(person_id) {	$.get('persons/' + person_id + '/telephones').done(function(xml) {		$('#telephones').html(xsl_transform(xml, XSL_TELEPHONES));		$('#telephones-messages').html(xsl_transform(xml, XSL_MESSAGES));	}).fail(function(response) {		var xml = response.responseXML;		$('#telephones-messages').html(xsl_transform(xml, XSL_MESSAGES));	});}$(document).ready(function() {	$.get('teltypes').done(function(xml) { XML_TELTYPES = xml; });	$.get('client/xsl/messages.xsl').done(function(xml) { XSL_MESSAGES = xml; });	$.get('client/xsl/persons.xsl').done(function(xml) { XSL_PERSONS = xml; });	$.get('client/xsl/person-form.xsl').done(function(xml) { XSL_PERSON_FORM = xml; });	$.get('client/xsl/telephones.xsl').done(function(xml) { XSL_TELEPHONES = xml; });	$.get('client/xsl/telephone-form.xsl').done(function(xml) { XSL_TELEPHONE_FORM = xml; });	reload_persons();		$(document).on('click', 'a.persons-refresh', function() {		reload_persons();		return false; 	});		$(document).on('click', 'a.person-add', function() {		//var xml = "<data><person><id/><fname/><lname/><address/></person></data>";		var new_person = { id: '', fname: '', lname: '',	address: '' };		var xml = xml_init_object('person', new_person);		$('#person-edit').html(xsl_transform(xml, XSL_PERSON_FORM));		$('#person-messages').html('');		return false;	});		$(document).on('click', 'a.person-edit', function() {		var person_id = $(this).attr('data-person-id');		$.get('persons/'+person_id).done(function(xml) {			$('#person-edit').html(xsl_transform(xml, XSL_PERSON_FORM));			$('#person-messages').html(xsl_transform(xml, XSL_MESSAGES));		}).fail(function(response) {			var xml = response.responseXML;			$('#person-messages').html(xsl_transform(xml, XSL_MESSAGES));		});		return false;	});		$(document).on('submit', '#person-edit > form', function() {		var edited_person = $(this).serializeObject();		var edited_person_dom = xml_init_object('person', edited_person);		$.postXML('persons/' + edited_person.id, edited_person_dom).done(function(xml) {			$('#person-edit').html('');			$('#person-messages').html(xsl_transform(xml, XSL_MESSAGES));			reload_persons();		}).fail(function(response) {			var xml = response.responseXML;			$('#person-messages').html(xsl_transform(xml, XSL_MESSAGES));		});		return false;	});		$(document).on('click', 'a.person-delete', function() {		var person_id = $(this).attr('data-person-id');		$.delete('persons/' + person_id).done(function(xml) {			reload_persons();			$('#person-messages').html(xsl_transform(xml, XSL_MESSAGES));		}).fail(function(response) {			var xml = response.responseXML;			$('#person-messages').html(xsl_transform(xml, XSL_MESSAGES));		});		return false;	});	$(document).on('click', 'a.person-telephones, a.telephones-refresh', function() {		var person_id = $(this).attr('data-person-id');		reload_telephones(person_id);		return false;	});		$(document).on('click', 'a.telephone-add', function() {		var person_id = $(this).attr('data-person-id');		var new_telephone = { id: '', person_id: person_id, number: '', teltype_id: '' };		var xml = xml_init_object('telephone', new_telephone);		var teltypes_iterator = XML_TELTYPES.evaluate('//teltypes', XML_TELTYPES, null, XPathResult.ANY_TYPE, null); 		xml.children[0].appendChild(teltypes_iterator.iterateNext().cloneNode(true));		$('#telephone-edit').html(xsl_transform(xml, XSL_TELEPHONE_FORM));		$('#telephone-messages').html('');		return false;	});		$(document).on('click', 'a.telephone-edit', function() {		var telephone_id = $(this).attr('data-telephone-id');		$.get('telephones/'+telephone_id).done(function(xml){			// XPath evaluation searches the XML_TELTYPES document			var teltypes_iterator = XML_TELTYPES.evaluate('//teltypes', XML_TELTYPES, null, XPathResult.ANY_TYPE, null); 			// whatever nodes we found above are inserted at the end of the current xml document			xml.children[0].appendChild(teltypes_iterator.iterateNext().cloneNode(true));			$('#telephone-edit').html(xsl_transform(xml, XSL_TELEPHONE_FORM));			$('#telephone-messages').html(xsl_transform(xml, XSL_MESSAGES));		});		return false;	});	$(document).on('submit', '#telephone-edit > form', function() {		var telephone = $(this).serializeObject();		var telephone_dom = xml_init_object('telephone', telephone);		$.postXML('telephones/' + telephone.id, telephone_dom).done(function(xml) {			$('#telephone-edit').html('');			$('#telephone-messages').html(xsl_transform(xml, XSL_MESSAGES));			reload_telephones(telephone.person_id);		}).fail(function(response) {			var xml = response.responseXML;			$('#telephone-messages').html(xsl_transform(xml, XSL_MESSAGES));		});		return false;	});		$(document).on('click', 'a.telephone-delete', function() {		var telephone_id = $(this).attr('data-telephone-id');		var person_id = $(this).attr('data-person-id');		$.delete('telephones/' + telephone_id).done(function() {			reload_telephones(person_id);		});		return false;	});});function xsl_transform(xml, xsl) {	var xsltProcessor = new XSLTProcessor();	xsltProcessor.importStylesheet(xsl);	return xsltProcessor.transformToFragment(xml, document);}function xml_init(xml_string) {	var parser = new DOMParser();	var xml_dom = parser.parseFromString(xml_string, "text/xml"); //important to use "text/xml"	return xml_dom;}function xml_init_object(name, obj) {	var parser = new DOMParser();	var dom = parser.parseFromString("<data><"+name+"></"+name+"></data>", "text/xml"); //important to use "text/xml"	var root = dom.getElementsByTagName(name);	for(var k in obj) {        var knode = dom.createElement(k);        var txt = dom.createTextNode(obj[k]);        knode.appendChild(txt);        root[0].appendChild(knode);	}	return dom;}